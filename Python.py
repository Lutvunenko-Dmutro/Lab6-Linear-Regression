import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from sklearn.linear_model import LinearRegression
from sklearn.metrics import r2_score

# --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏ ---
st.set_page_config(page_title="–õ–∞–± ‚Ññ6: –†–µ–≥—Ä–µ—Å—ñ–π–Ω–∏–π –∞–Ω–∞–ª—ñ–∑", layout="wide")

st.title("üìä –†–µ–≥—Ä–µ—Å—ñ–π–Ω–∏–π –∞–Ω–∞–ª—ñ–∑: –í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ vs –ö–∞–ø—ñ—Ç–∞–ª")
st.markdown("""
**–ü—Ä–∞–∫—Ç–∏—á–Ω–∞ —Ä–æ–±–æ—Ç–∞ ‚Ññ6**. 
–ê–Ω–∞–ª—ñ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –æ–±—Å—è–≥—É –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞ ($Y$) –≤—ñ–¥ —Ä–µ–∞–ª—å–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç –∫–∞–ø—ñ—Ç–∞–ª—É ($X$).
""")

# --- 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö ---
# –î–∞–Ω—ñ –≤–∑—è—Ç—ñ –∑ —Ç–∞–±–ª–∏—Ü—ñ —É –∑–∞–≤–¥–∞–Ω–Ω—ñ
data = {
    '–†—ñ–∫': [1899, 1900, 1901, 1902, 1903, 1904, 1905, 1906, 1907, 1908, 1909, 1910, 
            1911, 1912, 1913, 1914, 1915, 1916, 1917, 1918],
    'Y (–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ)': [100, 101, 112, 122, 124, 122, 143, 152, 151, 126, 155, 159, 
                        153, 177, 184, 169, 189, 225, 227, 223],
    'X (–í–∏—Ç—Ä–∞—Ç–∏)': [100, 107, 114, 122, 131, 138, 149, 163, 176, 185, 198, 208, 
                    153, 177, 184, 169, 189, 225, 227, 223]
}

df = pd.DataFrame(data)

# --- –°–∞–π–¥–±–∞—Ä (–ë–æ–∫–æ–≤–∞ –ø–∞–Ω–µ–ª—å) ---
st.sidebar.header("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")
show_data = st.sidebar.checkbox("–ü–æ–∫–∞–∑–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –¥–∞–Ω–∏—Ö", value=True)

# --- 2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä–µ–≥—Ä–µ—Å—ñ—ó ---
X = df[['X (–í–∏—Ç—Ä–∞—Ç–∏)']]
y = df['Y (–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ)']

model = LinearRegression()
model.fit(X, y)

# –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç—ñ–≤
intercept = model.intercept_ # a
slope = model.coef_[0]       # b
y_pred = model.predict(X)
r2 = r2_score(y, y_pred) # –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –¥–µ—Ç–µ—Ä–º—ñ–Ω–∞—Ü—ñ—ó

# --- 3. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è ---
col1, col2 = st.columns([2, 1])

with col1:
    st.subheader("–ì—Ä–∞—Ñ—ñ–∫ —Ä–µ–≥—Ä–µ—Å—ñ—ó")
    
    # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ—ñ–∫–∞ —á–µ—Ä–µ–∑ Plotly
    fig = px.scatter(
        df, x='X (–í–∏—Ç—Ä–∞—Ç–∏)', y='Y (–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ)', 
        hover_data=['–†—ñ–∫'], 
        title="–î—ñ–∞–≥—Ä–∞–º–∞ —Ä–æ–∑—Å—ñ—é–≤–∞–Ω–Ω—è —Ç–∞ –ª—ñ–Ω—ñ—è —Ä–µ–≥—Ä–µ—Å—ñ—ó",
        labels={'X (–í–∏—Ç—Ä–∞—Ç–∏)': '–†–µ–∞–ª—å–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ –∫–∞–ø—ñ—Ç–∞–ª—É (X)', 'Y (–í–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–æ)': '–û–±—Å—è–≥ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞ (Y)'},
        template="plotly_white"
    )
    
    # –î–æ–¥–∞–≤–∞–Ω–Ω—è –ª—ñ–Ω—ñ—ó —Ä–µ–≥—Ä–µ—Å—ñ—ó —á–µ—Ä–≤–æ–Ω–∏–º –∫–æ–ª—å–æ—Ä–æ–º
    fig.add_traces(go.Scatter(x=df['X (–í–∏—Ç—Ä–∞—Ç–∏)'], y=y_pred, mode='lines', name='–õ—ñ–Ω—ñ—è —Ä–µ–≥—Ä–µ—Å—ñ—ó', line=dict(color='red')))
    
    st.plotly_chart(fig, use_container_width=True)

with col2:
    st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–Ω–∞–ª—ñ–∑—É")
    
    st.info(f"**–†—ñ–≤–Ω—è–Ω–Ω—è —Ä–µ–≥—Ä–µ—Å—ñ—ó:**")
    st.latex(f"Y = {intercept:.2f} + {slope:.2f} \\cdot X")
    
    st.write("---")
    st.write(f"**–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç –Ω–∞—Ö–∏–ª—É ($b$):** {slope:.4f}")
    st.write(f"**–í—ñ–ª—å–Ω–∏–π —á–ª–µ–Ω ($a$):** {intercept:.4f}")
    st.write(f"**–¢–æ—á–Ω—ñ—Å—Ç—å –º–æ–¥–µ–ª—ñ ($R^2$):** {r2:.4f}")
    
    st.success("""
    **–í–∏—Å–Ω–æ–≤–æ–∫:** –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç $b > 0$ –≤–∫–∞–∑—É—î –Ω–∞ –ø—Ä—è–º—É –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å: –∑—ñ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è–º –≤–∏—Ç—Ä–∞—Ç –∫–∞–ø—ñ—Ç–∞–ª—É –∑—Ä–æ—Å—Ç–∞—î –æ–±—Å—è–≥ –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤–∞.
    """)

# --- 4. –¢–∞–±–ª–∏—Ü—è –¥–∞–Ω–∏—Ö ---
if show_data:
    st.subheader("–í–∏—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ")
    st.dataframe(df.style.highlight_max(axis=0), use_container_width=True)